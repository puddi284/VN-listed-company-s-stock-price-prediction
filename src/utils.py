# -*- coding: utf-8 -*-
"""Untitled2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15YEBuUwPqF8Tz_rrS34iAll1kgJy4Ttr
"""

import numpy as np

def inverse_transform_predictions_safe(
    y_pred_scaled_dict,
    X_test,
    scaler,
    target_col_log,
    all_cols,
    return_log=False
):
    results = {}
    target_index = all_cols.index(target_col_log)
    X_last = X_test[-len(next(iter(y_pred_scaled_dict.values()))):, -1, :]

    for model_name, y_pred_scaled in y_pred_scaled_dict.items():
        n_samples = len(y_pred_scaled)
        temp = np.zeros((n_samples, len(all_cols)))

        # Khôi phục lại ma trận ban đầu
        temp[:, target_index] = y_pred_scaled
        temp[:, :target_index] = X_last[:, :target_index]
        temp[:, target_index + 1:] = X_last[:, target_index:]

        # Biến đổi ngược lại
        full_inverse = scaler.inverse_transform(temp)
        log_price_pred = full_inverse[:, target_index]

        # Trả về log giá hoặc giá thật
        results[model_name] = log_price_pred if return_log else np.expm1(log_price_pred)

    return results