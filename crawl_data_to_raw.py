# -*- coding: utf-8 -*-
"""Untitled2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15YEBuUwPqF8Tz_rrS34iAll1kgJy4Ttr
"""

import os
import ast
import requests
import pandas as pd

def crawl_data(symbol, page_index, start_date="01/01/2022", end_date="02/28/2025"):
    url = "https://cafef.vn/du-lieu/Ajax/PageNew/DataHistory/PriceHistory.ashx"
    params = {
        "Symbol": symbol,
        "StartDate": start_date,
        "EndDate": end_date,
        "PageIndex": page_index,
        "PageSize": 20,
    }
    try:
        response = requests.get(url, params=params, timeout=10)
        response.raise_for_status()
        return pd.DataFrame(response.json().get("Data", []))
    except Exception as e:
        print(f"‚ùå Failed to fetch page {page_index} for {symbol}: {e}")
        return None

def parse_data(data_string):
    if isinstance(data_string, str):
        try:
            return ast.literal_eval(data_string.strip("()"))
        except:
            return {}
    return data_string if isinstance(data_string, dict) else {}

def parse_df(symbol, start_page, end_page):
    dfs = []
    for i in range(start_page, end_page):
        df = crawl_data(symbol, i)
        if df is not None:
            dfs.append(df)
    df = pd.concat(dfs, ignore_index=True) if dfs else pd.DataFrame()
    if df.empty:
        return df

    df['Data'] = df['Data'].apply(parse_data)
    df = pd.concat([df, pd.DataFrame(df['Data'].tolist())], axis=1)

    if 'ThayDoi' in df.columns:
        df[['Price_change', '%Price_change']] = df['ThayDoi'].apply(
            lambda val: pd.Series([val.split('(')[0], val.split('(')[1].rstrip('%)')]) if '(' in val else pd.Series([0, 0])
        )

    df.drop(columns=['Data', 'index', 'TotalCount', 'ThayDoi'], inplace=True, errors='ignore')
    df[['Price_change', '%Price_change']] = df[['Price_change', '%Price_change']].astype(float, errors='ignore')

    # Chuy·ªÉn gi√° t·ª´ ngh√¨n ƒë·ªìng sang ƒë·ªìng
    for col in ['GiaDieuChinh', 'GiaDongCua', 'GiaMoCua', 'GiaCaoNhat', 'GiaThapNhat', 'Price_change']:
        if col in df.columns:
            df[col] = df[col].astype(float, errors='ignore') * 1000

    df['Ngay'] = pd.to_datetime(df['Ngay'], format="%d/%m/%Y", errors='coerce')
    df = df.dropna(subset=['Ngay'])
    df = df.sort_values('Ngay').reset_index(drop=True)
    df['Return'] = df['GiaDongCua'].pct_change()
    return df.dropna().reset_index(drop=True)

if __name__ == "__main__":
    symbols = ["AGR", "FPT", "VNG", "HPG", "VNM", "VIC", "NVL", "SSI", "VND", "MWG", "PNJ", "TCB"]
    start_page = 1
    end_page = 41
    output_dir = "vn-stock-prediction/data/raw"
    os.makedirs(output_dir, exist_ok=True)

    for symbol in symbols:
        print(f"üì• Crawling: {symbol}")
        df = parse_df(symbol, start_page, end_page)
        if df is not None and not df.empty:
            df.to_csv(f"{output_dir}/{symbol}_raw.csv", index=False)
            print(f"‚úÖ Saved: {output_dir}/{symbol}_raw.csv")
        else:
            print(f"‚ö†Ô∏è No data for {symbol}")