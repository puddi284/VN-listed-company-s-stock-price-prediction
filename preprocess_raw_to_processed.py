# -*- coding: utf-8 -*-
"""Untitled2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15YEBuUwPqF8Tz_rrS34iAll1kgJy4Ttr
"""

import os
import pandas as pd

def preprocess_df(df):
    df['Ngay'] = pd.to_datetime(df['Ngay'], errors='coerce')
    df = df.dropna(subset=['Ngay'])
    df = df.sort_values('Ngay').reset_index(drop=True)
    df['Return'] = df['GiaDongCua'].pct_change()
    df['MA5'] = df['GiaDongCua'].rolling(window=5).mean()
    df['MA10'] = df['GiaDongCua'].rolling(window=10).mean()
    df['MA20'] = df['GiaDongCua'].rolling(window=20).mean()
    df['Volatility_5'] = df['Return'].rolling(window=5).std()
    df['OpenCloseGap'] = df['GiaDongCua'] - df['GiaMoCua']
    df['HighLowRange'] = df['GiaCaoNhat'] - df['GiaThapNhat']
    df['VolumeChange'] = df['KhoiLuongKhopLenh'].pct_change()
    return df.dropna().reset_index(drop=True)

if __name__ == "__main__":
    input_dir = "vn-stock-prediction/data/raw"
    output_dir = "vn-stock-prediction/data/processed"
    os.makedirs(output_dir, exist_ok=True)

    for filename in os.listdir(input_dir):
        if filename.endswith(".csv"):
            symbol = filename.replace("_raw.csv", "")
            print(f"⚙️ Đang xử lý: {symbol}")
            df = pd.read_csv(os.path.join(input_dir, filename))
            processed_df = preprocess_df(df)
            output_path = os.path.join(output_dir, f"{symbol}_processed.csv")
            processed_df.to_csv(output_path, index=False)
            print(f"✅ Đã lưu: {output_path}")